import{bg as e,j as t,P as a,Q as n,R as o,bh as s,r as l,V as r,X as i,bi as m,bj as c,q as d,p as u,_ as h,Z as C,$ as g,a0 as x,u as p,F as f,am as v,bk as j,C as b,T as _,ae as k,an as I,ba as N,bb as y,as as D,c as w,b8 as S,al as L,af as M,d as R,I as z,l as A,g as T,h as P,b9 as B,b2 as E,B as F,b as H,b7 as O,a_ as V,aC as X,k as U}from"./index-aT0gUlje.js";const $=e(t.jsx("path",{d:"M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"}),"Cancel");function K(e){return a("MuiChipDelete",e)}var q;n("MuiChipDelete",["root","disabled","focusVisible","colorPrimary","colorNeutral","colorDanger","colorSuccess","colorWarning","colorContext","variantPlain","variantSolid","variantSoft","variantOutlined"]);const J=["children","variant","color","disabled","onKeyDown","onDelete","onClick","component","slots","slotProps"],W=["onDelete"],G=o(s,{name:"JoyChipDelete",slot:"Root",overridesResolver:(e,t)=>t.root})((({theme:e})=>({"--IconButton-size":"var(--Chip-deleteSize, 2rem)","--Icon-fontSize":"calc(var(--IconButton-size, 2rem) / 1.3)",minWidth:"var(--IconButton-size, 2rem)",minHeight:"var(--IconButton-size, 2rem)",fontSize:e.vars.fontSize.sm,paddingInline:"2px",pointerEvents:"visible",borderRadius:"var(--Chip-deleteRadius, 50%)",zIndex:1,padding:0}))),Q=l.forwardRef((function(e,a){const n=r({props:e,name:"JoyChipDelete"}),{children:o,variant:s="plain",color:p="neutral",disabled:f,onKeyDown:v,onDelete:j,onClick:b,component:_,slots:k={},slotProps:I={}}=n,N=i(n,J),y=l.useContext(m),{variant:D=s,color:w=p}=c(e.variant,e.color,!0),S=e.color||w,L=null!=f?f:y.disabled,M=l.useRef(null),R=d(M,a),{focusVisible:z,getRootProps:A}=u(h({},n,{disabled:L,rootRef:R})),T=h({},n,{disabled:L,variant:D,color:S,focusVisible:z}),P=(e=>{const{focusVisible:t,variant:a,color:n,disabled:o}=e,s={root:["root",o&&"disabled",t&&"focusVisible",a&&`variant${g(a)}`,n&&`color${g(n)}`]};return x(s,K,{})})(T),B=h({},N,{component:_,slots:k,slotProps:I}),[E,F]=C("root",{ref:a,elementType:G,getSlotProps:A,externalForwardedProps:B,ownerState:T,additionalProps:{as:_,onKeyDown:e=>{["Backspace","Enter","Delete"].includes(e.key)&&(e.preventDefault(),!L&&j&&j(e)),v&&v(e)},onClick:e=>{!L&&j&&j(e),b&&b(e)}},className:P.root}),H=i(F,W);return t.jsx(E,h({},H,{children:null!=o?o:q||(q=t.jsx($,{}))}))})),Z={Comment:"_Comment_18lbo_1",CommentOverlay:"_CommentOverlay_18lbo_9",fade:"_fade_18lbo_1",CommentModal:"_CommentModal_18lbo_18",open:"_open_18lbo_1",CommentModalHeader:"_CommentModalHeader_18lbo_38",CommentModalLoading:"_CommentModalLoading_18lbo_44",CommentModalBody:"_CommentModalBody_18lbo_51",CommentItemLoading:"_CommentItemLoading_18lbo_59",CommentItem:"_CommentItem_18lbo_59",CommentItemContent:"_CommentItemContent_18lbo_72",CommentItemContentInner:"_CommentItemContentInner_18lbo_77",Content:"_Content_18lbo_80",CommentItemContentLikes:"_CommentItemContentLikes_18lbo_89",CommentItemAction:"_CommentItemAction_18lbo_95",CommentItemActionItem:"_CommentItemActionItem_18lbo_99",Liked:"_Liked_18lbo_109",CommentItemInfo:"_CommentItemInfo_18lbo_113",CommentModalAction:"_CommentModalAction_18lbo_124",UploadDragDropArea:"_UploadDragDropArea_18lbo_129",show:"_show_18lbo_147",DropInput:"_DropInput_18lbo_151",DropClose:"_DropClose_18lbo_162",PostContentImagePreview:"_PostContentImagePreview_18lbo_168",close:"_close_18lbo_179",fadeOut:"_fadeOut_18lbo_1"},Y=function(e){var t=Math.floor((new Date-e)/1e3),a=t/31536e3;return a>1?Math.floor(a)+"s":(a=t/2592e3)>1?Math.floor(a)+"mo":(a=t/86400)>1?Math.floor(a)+"d":(a=t/3600)>1?Math.floor(a)+"h":(a=t/60)>1?Math.floor(a)+"m":Math.floor(t)+"s"};const ee=l.memo((function(e){const[a,n]=l.useState(Y(1e3*e.time)),[o,s]=l.useState(e.likeCount),[r,i]=l.useState(e.liked),[m,c]=l.useState(!1),d=p(),u=l.useCallback((()=>{m||(c(!0),f({url:"comment",data:{action:"likeComment",cid:e.id,like:r},success:e=>{c(!1),s(e.data.count),i(e.data.liked)},error:e=>{c(!1),d.error(""!==e.message?e.message:"Lỗi không xác định!")}}))}),[r]);return l.useEffect((()=>{var t=setInterval((()=>{n(Y(1e3*e.time))}),1e3);return()=>{clearInterval(t)}})),t.jsxs("div",{className:Z.CommentItem,children:[t.jsxs("div",{className:Z.CommentItemInfo,children:[t.jsx(v,{alt:e.name,src:e.avatar}),t.jsx("p",{title:j(1e3*e.time).fromNow(),children:a})]}),t.jsxs("div",{className:Z.CommentItemContent,children:[t.jsxs(b,{variant:"soft",className:Z.CommentItemContentInner,children:[t.jsx(_,{level:"h2",fontSize:"sm",children:t.jsxs(k,{to:"/profile/uid/"+e.uid,children:[e.name,t.jsx(I,{verifyLevel:e.verified,mod:e.mod,style:{marginLeft:5}})]})}),t.jsx("div",{className:Z.Content,children:t.jsx(N,{children:e.content,remarkPlugins:[y],skipHtml:!0})}),o>0&&t.jsx(D,{variant:"soft",size:"sm",startDecorator:t.jsx(Q,{children:t.jsx("i",{className:"fa-duotone fa-thumbs-up"})}),className:Z.CommentItemContentLikes,children:o})]}),t.jsxs("div",{className:Z.CommentItemAction,children:[t.jsx("a",{onClick:u,className:w(Z.CommentItemActionItem,r&&Z.Liked),ac:"likeComment",children:m?"...":r?"Đã thích":"Thích"}),e.okToRemove&&t.jsx("a",{onClick:()=>e.delComment(e.id),className:Z.CommentItemActionItem,ac:"deleteComment",children:"Xóa"})]})]})]})})),te=function(e){var t=Math.floor((new Date-e)/1e3),a=t/31536e3;return a>1?Math.floor(a)+"s":(a=t/2592e3)>1?Math.floor(a)+"mo":(a=t/86400)>1?Math.floor(a)+"d":(a=t/3600)>1?Math.floor(a)+"h":(a=t/60)>1?Math.floor(a)+"m":Math.floor(t)+"s"};const ae=l.memo((function(e){const{setShowLoading:a}=l.useContext(S),[n,o]=l.useState(!1),[s,r]=l.useState(te(1e3*e.time)),[i,m]=l.useState(e.likeCount),[c,d]=l.useState(!1),[u,h]=l.useState(e.liked),[C,g]=l.useState(!1),x=p(),[E,F]=l.useState(!1),[H,O]=l.useState([]),[V,X]=l.useState(""),[U,$]=l.useState(!1),K=l.useCallback((()=>{var t=new Image;t.src=e.image;var a=new L(t,{hidden:function(){a.destroy()},title:!1,navbar:!1});a.show()})),q=l.useCallback((()=>{C||(g(!0),f({url:"comment",data:{action:"likeComment",cid:e.id,like:u},success:e=>{g(!1),m(e.data.count),h(e.data.liked)},error:e=>{g(!1),x.error(""!==e.message?e.message:"Lỗi không xác định!")}}))}),[u]),J=()=>{V.length<3||V.length>2e3&&!0===J||($(!0),f({url:"comment",data:{action:"addComment",cid:e.id,content:V,pid:e.pid},success:e=>{$(!1),X(""),O([e.data.out,...H])},error:e=>{$(!1),x.error(""!==e.message?e.message:"Lỗi không xác định!")}}))},W=l.useCallback((()=>{E||(H.length>0?O([]):(F(!0),f({url:"comment",data:{action:"loadReply",cid:e.id},success:e=>{F(!1),O(e.data)},error:e=>{F(!1),x.error(""!==e.message?e.message:"Lỗi không xác định!")}})))})),G=async e=>{if(n)return void x.error("Vui lòng đợi cho hành động trước hoàn tất!");"CONFIRMED"===await T.show({type:P.Confirm,title:"Xoá bình luận",message:t.jsx(t.Fragment,{children:"Bạn có muốn xóa bình luận này không?"})})&&(o(!0),a(!0),f({url:"comment",data:{action:"delete",cid:e},success:t=>{let n=H;B.remove(n,(t=>t.id===e)),O(n),a(!1),o(!1),x.success("Đã xóa bình luận!")},error:e=>{a(!1),o(!1),x.error(""!==e.message?e.message:"Lỗi không xác định!")}}))};return l.useEffect((()=>{var t=setInterval((()=>{r(te(1e3*e.time))}),1e3);return()=>{clearInterval(t)}})),t.jsxs("div",{className:Z.CommentItem,children:[t.jsxs("div",{className:Z.CommentItemInfo,children:[t.jsx(v,{alt:e.name,src:e.avatar}),t.jsx("p",{title:j(1e3*e.time).fromNow(),children:s})]}),t.jsxs("div",{className:Z.CommentItemContent,children:[t.jsxs(b,{variant:"soft",className:Z.CommentItemContentInner,children:[t.jsx(_,{level:"h2",fontSize:"sm",children:t.jsxs(k,{to:"/profile/uid/"+e.uid,children:[e.name,t.jsx(I,{verifyLevel:e.verified,mod:e.mod,style:{marginLeft:5}})]})}),t.jsx("div",{className:Z.Content,children:t.jsx(N,{children:e.content,remarkPlugins:[y],skipHtml:!0})}),""!==e.image&&t.jsx(M,{variant:"soft",sx:{"--AspectRatio-paddingBottom":"clamp(0px, (100% - 200px) * 999, 200px)",marginTop:1,cursor:"pointer"},children:t.jsx("img",{onClick:K,alt:"",src:e.image})}),i>0&&t.jsx(D,{variant:"soft",size:"sm",startDecorator:t.jsx(Q,{children:t.jsx("i",{className:"fa-duotone fa-thumbs-up"})}),className:Z.CommentItemContentLikes,children:i})]}),t.jsxs("div",{className:Z.CommentItemAction,children:[t.jsx("a",{onClick:q,className:w(Z.CommentItemActionItem,u&&Z.Liked),ac:"likeComment",children:C?"...":u?"Đã thích":"Thích"}),t.jsx("a",{className:Z.CommentItemActionItem,onClick:()=>d(!c),ac:"replyComment",children:"Trả lời"}),e.lengthReply>0&&t.jsx("a",{className:Z.CommentItemActionItem,onClick:W,ac:"showReply",children:E?"Vui lòng chờ...":H.length>0?"Ẩn tất cả":"Hiện thêm "+e.lengthReply+" câu trả lời"}),e.okToRemove&&t.jsx("a",{onClick:()=>e.delComment(e.id),className:Z.CommentItemActionItem,ac:"deleteComment",children:"Xóa"})]}),t.jsxs("div",{className:Z.CommentItemReply,children:[c&&t.jsx("div",{className:Z.CommentItemReplyBox,children:t.jsx(R,{children:t.jsx(z,{placeholder:"Trả lời bình luận của "+e.name,value:V,onChange:e=>X(e.target.value),startDecorator:t.jsx(A,{onClick:()=>d(!1),size:"sm",variant:"plain",children:t.jsx("i",{className:"fa-duotone fa-xmark"})}),endDecorator:t.jsx(D,{size:"sm",variant:"soft",onClick:J,sx:{cursor:"pointer"},children:U?"Đang đăng...":"Đăng"})})})}),H.map(((e,a)=>t.jsx(ee,{delComment:G,...e},e.id+"x"+a)))]})]})]})}));const ne=l.memo((function({pid:e}){const{setCommentData:a,commentData:n}=l.useContext(oe),[o,s]=l.useState(""),[r,i]=l.useState(null),[m,c]=l.useState(!1),[d,u]=l.useState(""),[h,C]=l.useState(!1),g=l.useRef(null),x=l.useRef(null),v=p(),j=e=>{c(!1);const t=e.target.files[0];0!==t.length&&t.type.includes("image/")?i(e.target.files[0]):(e.target.value="",v.error("Chỉ chấp nhận tệp ảnh!"))},b=l.useCallback((()=>{if(null===r&&o.length<4||o.length>2e3)v.error("Vui lòng chọn ảnh hoặc bình luận phải có 3 ký tự trở lên!");else{var t=new FormData;t.append("action","addComment"),t.append("content",o),t.append("pid",e),null!==r&&t.append("image",r),f({url:"comment",data:t,beforeSend:()=>C(!0),success:e=>{C(!1),v.success("Đăng bình luận thành công!"),u(""),s(""),i(null),a({...n,data:[e.data.out,...n.data]})},error:e=>{C(!1),v.error(""!==e.message?e.message:"Lỗi không xác định!")}})}}),[o,r,n]);return l.useEffect((()=>{if(null!==r){var e=new FileReader;e.onload=e=>{u(e.target.result)},e.readAsDataURL(r)}}),[r]),l.useEffect((()=>{function e(e){const t=e.clipboardData.items,a=[].slice.call(t).filter((function(e){return/^image\//.test(e.type)}));if(0===a.length)return;const n=a[0].getAsFile();let o=new File([n],"file name",{type:"image/jpeg",lastModified:(new Date).getTime()},"utf-8"),s=new DataTransfer;s.items.add(o),x.current.files=s.files,j({target:x.current})}var t;g.current.addEventListener("paste",e);const a=e=>{var a=e.dataTransfer;a.types&&(a.types.indexOf?-1!=a.types.indexOf("Files"):a.types.contains("Files"))&&(c(!0),window.clearTimeout(t))},n=e=>{t=window.setTimeout((function(){c(!1)}),25)};return document.addEventListener("dragover",a),document.addEventListener("dragleave",n),()=>{document.removeEventListener("dragover",a),document.removeEventListener("dragleave",n),g.current&&g.current.removeEventListener("paste",e)}}),[]),t.jsxs("div",{className:Z.CommentModalAction,children:[t.jsxs("div",{className:w(Z.UploadDragDropArea,m&&Z.show),children:[t.jsx("input",{type:"file",className:Z.DropInput,ref:x,onChange:j}),t.jsx("h4",{children:"Thả tệp vào đây..."}),t.jsx(A,{variant:"plain",size:"sm",className:Z.DropClose,onClick:()=>c(!1),children:t.jsx("i",{className:"fa-duotone fa-xmark"})})]}),t.jsxs(R,{children:[null!==r&&t.jsx("div",{className:Z.PostContentImagePreview,style:{backgroundImage:`url(${d})`}}),t.jsx(E,{placeholder:"Bình luận của bạn",variant:"outlined",minRows:2,ref:g,sx:{maxHeight:"120px"},value:o,onChange:e=>s(e.target.value),endDecorator:t.jsxs(F,{sx:{display:"flex",gap:"var(--Textarea-paddingBlock)",pt:"var(--Textarea-paddingBlock)",borderTop:"1px solid",borderColor:"divider",flex:"auto"},children:[t.jsx(A,{variant:"plain",onClick:()=>{if(null!==r)return i(null),void u(null);x.current.click()},children:t.jsx("i",{className:"fa-duotone "+(null!==r?"fa-xmark":"fa-image")})}),t.jsx(H,{sx:{ml:"auto"},onClick:b,loading:h,disabled:!0===h||null===r&&o.length<4||o.length>2e4,children:"Đăng"})]})})]})]})})),oe=l.createContext();const se=l.memo((function(){const{setShowLoading:e}=l.useContext(S),[a,n]=l.useState(!1);let{pid:o}=O();const[s,r]=l.useState(!0),[i,m]=l.useState({data:[],stop:!1,loading:!1,start:0}),[c,d]=l.useState(!1),u=V(),h=p(),C=l.useCallback((e=>{d(!0),setTimeout((()=>u(!0===e?"/creator/media/id/"+o:-1)),200)}),[o]),g=l.useCallback((()=>{!0!==i.stop&&!0!==i.loading&&(m({...i,loading:!0}),f({url:"comment",data:{action:"getComment",start:i.start,pid:o},success:e=>{e.data.length<1?m({...i,loading:!1,stop:!0}):m({...i,loading:!1,stop:!1,start:i.start+25,data:[...i.data,...e.data]})},error:e=>{m({...i,loading:!1,stop:!0}),h.error(""!==e.message?e.message:"Lỗi không xác định!")}}))}),[i]),x=async o=>{if(a)return void h.error("Vui lòng đợi cho hành động trước hoàn tất!");"CONFIRMED"===await T.show({type:P.Confirm,title:"Xoá bình luận",message:t.jsx(t.Fragment,{children:"Bạn có muốn xóa bình luận này không?"})})&&(n(!0),e(!0),f({url:"comment",data:{action:"delete",cid:o},success:()=>{let t=i.data;B.remove(t,(e=>e.id===o)),m({...i,data:t}),e(!1),n(!1),h.success("Đã xóa bình luận!")},error:t=>{e(!1),n(!1),h.error(""!==t.message?t.message:"Lỗi không xác định!")}}))};return l.useEffect((()=>{document.title="Bình luận bài viết | Mon Fansub",r(!0),f({url:"comment",data:{action:"get",pid:o},success:()=>{r(!1),g()},error:e=>{C(),h.error(""!==e.message?"Lỗi: "+e.message:"Lỗi không xác định!")}})}),[]),t.jsx(t.Fragment,{children:t.jsx(oe.Provider,{value:{setCommentData:m,commentData:i},children:t.jsxs("div",{className:w(Z.Comment,c&&Z.close),children:[t.jsx("div",{className:Z.CommentOverlay,onClick:C}),t.jsxs("div",{className:Z.CommentModal,children:[t.jsxs("div",{className:Z.CommentModalHeader,children:[t.jsx("h3",{style:{flexGrow:1},children:"Bình luận bài viết"}),t.jsx(X,{title:"Xem bài viết",children:t.jsx(A,{sx:{ml:1},onClick:()=>C(!0),size:"sm",variant:"plain",children:t.jsx("i",{className:"fa-duotone fa-arrow-up-right-from-square"})})}),t.jsx(A,{onClick:C,size:"sm",variant:"plain",children:t.jsx("i",{className:"fa-duotone fa-xmark"})})]}),s?t.jsx("div",{className:Z.CommentModalLoading,children:t.jsx(U,{size:"lg"})}):t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:Z.CommentModalBody,onScroll:e=>{e.target.scrollHeight-e.target.offsetHeight-e.target.scrollTop<50&&g()},children:[i.data.map((e=>t.jsx(ae,{pid:o,delComment:x,...e},e.id))),i.loading&&t.jsx("div",{className:Z.CommentItemLoading,children:t.jsx(U,{size:"md"})})]}),t.jsx(ne,{pid:o})]})]})]})})})}));export{oe as CommentContext,se as default};
